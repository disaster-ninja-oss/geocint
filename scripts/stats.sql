select ST_AsMVT(q, 'stats', 8192, 'geom')
from
    (
        select
            count,
            count_6_months,
            building_count,
            building_count_6_months,
            highway_length,
            highway_length_6_months,
            osm_users,
            population,
            gdp,
            coalesce(min_ts, 0) as min_ts,
            coalesce(max_ts, 0) as max_ts,
            coalesce(avgmax_ts, 0) as avgmax_ts,
            area_km2,
            populated_area_km2,
            local_hours,
            total_hours,
            view_count,
            one,
            total_building_count,
            wildfires,
            covid19_vaccines,
            avg_slope,
            forest,
            avg_ndvi,
            covid19_confirmed,
            population_prev,
            industrial_area,
            volcanos_count,
            pop_under_5_total,
            pop_over_65_total,
            poverty_families_total,
            pop_disability_total,
            pop_not_well_eng_speak,
            pop_without_car,
            evergreen_needle_leaved_forest,
            shrubs,
            herbage,
            unknown_forest,
            avg_elevation,
            days_maxtemp_over_32c_1c,
            days_maxtemp_over_32c_2c,
            days_mintemp_above_25c_1c,
            days_mintemp_above_25c_2c,
            days_maxwetbulb_over_32c_1c,
            days_maxwetbulb_over_32c_2c,
            mandays_maxtemp_over_32c_1c,
            man_distance_to_fire_brigade,
            man_distance_to_hospital,
            total_road_length,
            foursquare_visits_count,
            foursquare_places_count,
            view_count_bf2402,
            raw_mhe_pop_scaled,
            raw_mhe_cap_scaled,
            raw_mhe_index,
            relative_mhe_pop_scaled,
            relative_mhe_cap_scaled,
            relative_mhe_index,
            mhe_index,
            life_expectancy_scale,
            infant_mortality_scale,
            maternal_mortality_scale,
            prevalence_undernourished_scale,
            vulnerable_health_status_index,
            pop_wout_improved_sanitation_scale,
            pop_wout_improved_water_scale,
            clean_water_access_vulnerability_index,
            adult_illiteracy_scale,
            gross_enrollment_scale,
            years_of_schooling_scale,
            pop_wout_internet_scale,
            info_access_vulnerability_index,
            export_minus_import_percent_scale,
            average_inflation_scale,
            economic_dependency_scale,
            economic_constraints_index,
            female_govt_seats_scale,
            female_male_secondary_enrollment_scale,
            female_male_labor_ratio_scale,
            gender_inequality_index,
            max_political_discrimination_scale,
            max_economic_discrimination_scale,
            ethnic_discrimination_index,
            marginalization_index,
            population_change_scale,
            urban_population_change_scale,
            population_pressures_index,
            freshwater_withdrawals_scale,
            forest_area_change_scale,
            ruminant_density_scale,
            environmental_stress_index,
            recent_disaster_losses_scale,
            recent_disaster_deaths_scale,
            recent_disaster_impacts_index,
            recent_conflict_deaths_scale,
            displaced_populations_scale,
            conflict_impacts_index,
            vulnerability_index,
            voice_and_accountability_scale,
            rule_of_law_scale,
            political_stability_scale,
            govt_effectiveness_scale,
            control_of_corruption_scale,
            governance_index,
            gni_per_capita_scale,
            reserves_per_capita_scale,
            economic_capacity_index,
            fixed_phone_access_scale,
            mobile_phone_access_scale,
            internet_server_access_scale,
            communications_capacity_index,
            port_rnwy_density_scale,
            road_rr_density_scale,
            transportation_index,
            hospital_bed_density_scale,
            nurses_midwives_scale,
            physicians_scale,
            health_care_capacity_index,
            infrastructure_capacity_index,
            biome_protection_scale,
            marine_protected_area_scale,
            environmental_capacity_index,
            coping_capacity_index,
            resilience_index,
            mhr_index,
            ST_AsMVTGeom(geom, ST_TileEnvelope($1, $2, $3), 8192, 64, true) as geom
        from stat_h3
        where zoom = $1
          and geom && ST_TileEnvelope($1, $2, $3)
    ) as q;
